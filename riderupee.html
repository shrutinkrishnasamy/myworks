<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Riderupee.in</title>
    <link rel="icon" href="riderupeelogo.PNG" type="image/png" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        :root { --brand: #ff6600; }
        .navbar { background: var(--brand); }
        #map { height: 60vh; width: 100%; }
        .view { display: none; }
        .active-view { display: block; }
        .cursor-pointer { cursor: pointer; }
        .chat-box { max-height: 320px; overflow-y: auto; }
        #alert-area { position: fixed; top: 70px; right: 20px; z-index: 2000; width: 320px; }
        .otp-grid { display: grid; grid-template-columns: 1fr auto; gap: .5rem; }
        .role-badge { font-size: .8rem; }
        .driver-only { display: none; }
        .user-only { display: none; }
    </style>
</head>
<body>
    <!-- Top Nav -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" id="brand-link">Riderupee.in</a>
            <div class="d-flex align-items-center" id="nav-right">
                <span id="user-name" class="text-white me-3"></span>
                <span id="badge-role" class="badge text-bg-dark role-badge me-3" style="display:none"></span>
                <button id="btn-profile-nav" class="btn btn-outline-light btn-sm me-2" style="display:none">Profile</button>
                <button id="btn-logout" class="btn btn-outline-light btn-sm" style="display:none">Logout</button>
            </div>
        </div>
    </nav>

    <div id="alert-area"></div>

    <div class="container my-4">

        <!-- PAGE 1 — LOGIN -->
        <div id="view-login" class="view active-view">
            <div class="row justify-content-center">
                <div class="col-lg-6">
                    <div class="card p-4 shadow-sm">
                        <h3 class="mb-3">Sign in to Riderupee</h3>
                        <p class="text-muted small">Drivers update their location, passengers find rides instantly.</p>

                        <div class="mb-3">
                            <label class="form-label">Continue as</label>
                            <select id="role-select" class="form-select">
                                <option value="user">User (Passenger)</option>
                                <option value="driver">Driver</option>
                            </select>
                        </div>

                        <button id="btn-google-signin" class="btn btn-dark w-100 mb-3">Sign in with Google</button>

                        <div class="text-center text-muted my-2">— or —</div>

                        <div class="card p-3 border-0 bg-light mb-3">
                            <label class="form-label">Phone sign-in (OTP)</label>
                            <div class="input-group mb-2">
                                <span class="input-group-text">+91</span>
                                <input id="phone-input" type="tel" class="form-control" placeholder="10-digit number" />
                            </div>
                            <div class="otp-grid mb-2">
                                <button id="btn-send-otp" class="btn btn-primary" type="button">Send OTP</button>
                                <div id="recaptcha-container"></div>
                            </div>
                            <div class="input-group">
                                <input id="otp-input" class="form-control" placeholder="Enter OTP" />
                                <button id="btn-verify-otp" class="btn btn-success" type="button">Verify</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE 2 — MAIN / SEARCH (User) -->
        <div id="view-user-main" class="view user-only">
            <div class="row">
                <div class="col-md-8">
                    <div class="card mb-3 p-3">
                        <h5>Find nearby taxis</h5>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <input id="search-address" class="form-control" placeholder="Enter address or location" />
                            <button id="btn-search" class="btn btn-primary">Search</button>
                            <button id="btn-my-loc" class="btn btn-outline-secondary">Use my location</button>
                        </div>
                        <div id="map" class="border rounded"></div>
                    </div>

                    <div class="card p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Nearby Taxis</h5>
                            <span class="text-muted small" id="nearby-count"></span>
                        </div>
                        <ul id="nearby-list" class="list-group mt-2"></ul>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card p-3 mb-3">
                        <h5>My Profile</h5>
                        <div id="user-profile-summary"></div>
                        <button id="btn-open-user-profile" class="btn btn-outline-primary btn-sm mt-3">Edit Profile</button>
                    </div>
                    <div class="card p-3">
                        <h5>My Chats</h5>
                        <ul id="chats-list" class="list-group"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE 3 — DRIVER EDIT PAGE -->
        <div id="view-driver-edit" class="view driver-only">
            <div class="card p-4">
                <h4>Driver Control Panel</h4>
                <p class="text-muted">Update your vehicle details, costs, and manage your live location.</p>
                <form id="driver-edit-form">
                    <div class="mb-3">
                        <label class="form-label">Vehicle Image URL (optional)</label>
                        <input id="driver-vehicle-image" class="form-control" placeholder="e.g., https://example.com/taxi.jpg" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Vehicle Info</label>
                        <input id="driver-vehicle-info" class="form-control" placeholder="e.g. Toyota Innova - TN59AB1234" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Cost per km (₹)</label>
                        <input id="driver-cost-per-km" type="number" step="0.5" class="form-control" placeholder="e.g., 12.50" required />
                    </div>
                    <div class="d-grid gap-2 mb-4">
                        <button class="btn btn-primary" type="submit">Save Details</button>
                    </div>
                </form>
                
                <h5>Live Location Updates</h5>
                <div class="card p-3 bg-light">
                    <small class="text-muted mb-2">Your current location is how users find you. Enable auto-update for best results.</small>
                    <div class="row g-2 mb-2">
                        <div class="col-6"><input id="driver-lat" class="form-control form-control-sm" placeholder="Latitude" /></div>
                        <div class="col-6"><input id="driver-lng" class="form-control form-control-sm" placeholder="Longitude" /></div>
                    </div>
                    <div class="d-flex gap-2">
                        <button id="btn-update-loc" class="btn btn-sm btn-secondary" type="button">Manual Update</button>
                        <button id="btn-auto-loc" class="btn btn-sm btn-success" type="button">Start Auto-update (GPS)</button>
                        <button id="btn-auto-loc-stop" class="btn btn-sm btn-danger" type="button" style="display:none">Stop</button>
                    </div>
                </div>

                <div class="d-grid mt-4">
                    <button id="btn-driver-view-profile" class="btn btn-outline-secondary">View My Public Profile</button>
                </div>
            </div>
        </div>

        <!-- PAGE 4 — USER PROFILE -->
        <div id="view-user-profile" class="view user-only">
            <div class="card p-3">
                <h4>My Profile</h4>
                <p class="text-muted">Manage your personal information.</p>
                <form id="user-profile-form">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input id="user-profile-name" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input id="user-profile-email" class="form-control" disabled />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input id="user-profile-phone" class="form-control" disabled />
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" type="submit">Save Profile</button>
                        <button type="button" id="btn-back-main-from-user-profile" class="btn btn-link">Back</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- PAGE 5 — CHAT (user ↔ driver) -->
        <div id="view-chat" class="view">
            <div class="card p-3">
                <div class="d-flex align-items-center justify-content-between">
                    <h4 class="mb-0">Chat with <span id="chat-with-name"></span></h4>
                    <button type="button" id="btn-chat-back" class="btn btn-link">Back</button>
                </div>
                <div class="chat-box border p-2 my-2" id="chat-messages"></div>
                <form id="chat-form" class="d-flex gap-2">
                    <input id="chat-input" class="form-control" placeholder="Type a message or ask for a price" />
                    <button class="btn btn-primary" type="submit">Send</button>
                </form>
            </div>
        </div>

        <!-- PAGE 6 — DRIVER PROFILE (Read-only for users) -->
        <div id="view-driver-profile" class="view">
            <div class="card p-4">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h4 class="mb-0">Driver Profile</h4>
                    <button type="button" id="btn-driver-profile-back" class="btn btn-link">Back</button>
                </div>
                <div id="driver-profile-details">
                    <div class="text-center text-muted">Loading driver profile...</div>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white text-center text-lg-start mt-5">
        <div class="container p-4">
            <div class="row align-items-center">
                <div class="col-lg-6 col-md-12 mb-4 mb-md-0 text-start">
                    <div class="d-flex align-items-center mb-2">
                        <img src="riderupee.PNG" alt="RideRupee Logo" width="60" class="me-2" />
                        <h5 class="mb-0">Riderupee.in</h5>
                    </div>
                    <p class="mt-2">₹ide. ₹elax. ₹epeat.</p>
                </div>
                <div class="col-lg-6 col-md-12 mb-4 mb-md-0 text-md-end">
                    <p>Made with ❤️ in India</p>
                    <p class="mb-0">Contact: <a href="mailto:riderupee@gmail.com" class="text-white">riderupee@gmail.com</a></p>
                </div>
            </div>
        </div>
        <div class="text-center p-3 bg-dark text-white">© 2025 RideRupee. All rights reserved.</div>
    </footer>

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ===================== CONFIG — REPLACE WITH YOUR KEYS =====================
        const firebaseConfig = {
            apiKey: "AIzaSyCCsKOb_1Ug4oHbtuhnqqHIKILXKjTIB1s",
            authDomain: "riderupee-3d6a7.firebaseapp.com",
            projectId: "riderupee-3d6a7",
            storageBucket: "riderupee-3d6a7.firebaseapp.com",
            messagingSenderId: "723828361707",
            appId: "1:723828361707:web:c077cae44fcbd54c2f71ae",
            measurementId: "G-T79VTL0N2L"
        };
        const GOOGLE_MAPS_API_KEY = 'AIzaSyB1RbsWO7JEU3u2QscTiumFQWrTyll20E8';
        // =============================================================================

        // ---------- UI helpers ----------
        function showAlert(msg, type = 'danger', timeout = 6000){
            const id = 'alert' + Date.now();
            const container = document.getElementById('alert-area');
            const div = document.createElement('div');
            div.className = `alert alert-${type} alert-dismissible fade show`;
            div.id = id;
            div.innerHTML = `<div class="small">${msg}</div><button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            container.appendChild(div);
            if(timeout) setTimeout(()=>{ try{ const e = document.getElementById(id); if(e){ e.remove(); } } catch(e){} }, timeout);
        }
        function showView(id){
            document.querySelectorAll('.view').forEach(v=>v.classList.remove('active-view'));
            const el = document.getElementById(id);
            if(el) {
                el.classList.add('active-view');
                if (el.classList.contains('user-only')) {
                    document.querySelectorAll('.user-only').forEach(e => e.style.display = 'block');
                    document.querySelectorAll('.driver-only').forEach(e => e.style.display = 'none');
                } else if (el.classList.contains('driver-only')) {
                    document.querySelectorAll('.driver-only').forEach(e => e.style.display = 'block');
                    document.querySelectorAll('.user-only').forEach(e => e.style.display = 'none');
                } else {
                    document.querySelectorAll('.user-only').forEach(e => e.style.display = 'block');
                    document.querySelectorAll('.driver-only').forEach(e => e.style.display = 'block');
                }
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ---------- Firebase boot ----------
        let db = null, auth = null;
        try{
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        }catch(e){ showAlert('Firebase init failed: ' + e.message, 'danger', 0); }

        // ---------- Google Maps ----------
        let map, geocoder, userMarker, currentLocation = null;
        function initMap(){
            try{
                geocoder = new google.maps.Geocoder();
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 10.3655, lng: 77.9706 },
                    zoom: 13,
                    mapTypeControl: false,
                });
                map.addListener('click', (e)=> setUserLocation(e.latLng.lat(), e.latLng.lng()));
                watchDrivers();
            }catch(e){ showAlert('Maps init error: ' + e.message); }
        }
        function loadMaps(){
            if(!GOOGLE_MAPS_API_KEY){ showAlert('Google Maps API key missing', 'warning'); return; }
            const s = document.createElement('script');
            s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap`;
            s.async = true; s.defer = true;
            window.initMap = initMap;
            document.head.appendChild(s);
        }

        function setUserLocation(lat,lng){
            currentLocation = { lat, lng };
            if(userMarker) userMarker.setMap(null);
            if(window.google && map){
                userMarker = new google.maps.Marker({ position: { lat, lng }, map, title: 'You', icon: { url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" } });
                map.panTo({ lat, lng });
            }
            refreshNearbyList();
        }

        // ---------- Auth (Google + Phone) ----------
        let recaptchaVerifier = null, confirmationResult = null;
        function setupRecaptcha(){
            try{
                if(recaptchaVerifier) recaptchaVerifier.clear();
                recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
                recaptchaVerifier.render();
            }catch(e){ showAlert('reCAPTCHA error: ' + e.message); }
        }

        async function signInWithGoogle(){
            const role = document.getElementById('role-select').value || 'user';
            const provider = new firebase.auth.GoogleAuthProvider();
            try{
                const res = await auth.signInWithPopup(provider);
                await ensureProfile(res.user, { role });
            }catch(e){ showAlert('Google sign-in failed: ' + e.message); }
        }

        async function sendOtp(){
            const raw = (document.getElementById('phone-input').value||'').replace(/\D/g,'');
            if(raw.length !== 10) return showAlert('Enter a valid 10-digit phone number.', 'warning');
            const phone = '+91' + raw;
            setupRecaptcha();
            try{
                confirmationResult = await auth.signInWithPhoneNumber(phone, recaptchaVerifier);
                showAlert('OTP sent. Please check your phone.', 'success');
            }catch(e){ showAlert('OTP send failed: ' + e.message); }
        }

        async function verifyOtp(){
            const code = (document.getElementById('otp-input').value||'').trim();
            if(!confirmationResult) return showAlert('Send OTP first.');
            try{
                const res = await confirmationResult.confirm(code);
                const role = document.getElementById('role-select').value || 'user';
                await ensureProfile(res.user, { role, phoneLogin: true });
            }catch(e){ showAlert('OTP verification failed: ' + e.message); }
        }

        async function ensureProfile(user, opts={}){
            if(!db) return;
            const ref = db.collection('profiles').doc(user.uid);
            const snap = await ref.get();
            if(!snap.exists){
                await ref.set({
                    uid: user.uid,
                    name: user.displayName || '',
                    email: user.email || '',
                    phone: user.phoneNumber || '',
                    role: opts.role || 'user',
                    vehicle: '',
                    costPerKm: 0,
                    vehicleImage: '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }else{
                const p = snap.data();
                if(p.name === ''){
                    await ref.update({ name: user.displayName || (p.role === 'driver' ? 'New Driver' : 'New User') });
                }
                if(p.role !== opts.role){
                    await ref.update({ role: opts.role });
                }
            }
        }
        
        async function getProfileData(uid){
            if(!db) return null;
            const snap = await db.collection('profiles').doc(uid).get();
            return snap.exists ? snap.data() : null;
        }

        // ---------- Driver presence / live update ----------
        let driversUnsub = null, driverAutoTimer = null;
        function watchDrivers(){
            if(!db) return;
            if(driversUnsub) driversUnsub();
            driversUnsub = db.collection('profiles').where('role','==','driver').onSnapshot(snap=>{
                const drivers = [];
                snap.forEach(d=> drivers.push({ id: d.id, ...d.data() }));
                window._lastDriversSnapshot = drivers;
                if(window.google && map){
                    if(window._riderMarkers){ window._riderMarkers.forEach(m=>m.setMap(null)); }
                    window._riderMarkers = [];
                    drivers.forEach(d=>{
                        if(typeof d.lat === 'number' && typeof d.lng === 'number'){
                            const marker = new google.maps.Marker({ position: { lat: d.lat, lng: d.lng }, map, title: d.name || 'Driver', icon: { url: "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png" } });
                            marker.addListener('click', ()=> showDriverProfile(d.id));
                            window._riderMarkers.push(marker);
                        }
                    });
                }
                refreshNearbyList();
            }, err => showAlert('Drivers stream error: ' + err.message));
        }

        // ---------- Nearby list ----------
        function distanceKm(a,b){
            const R = 6371, dLat = (b.lat-a.lat)*Math.PI/180, dLon = (b.lng-a.lng)*Math.PI/180;
            const la = a.lat*Math.PI/180, lb = b.lat*Math.PI/180;
            const A = Math.sin(dLat/2)**2 + Math.cos(la)*Math.cos(lb)*Math.sin(dLon/2)**2;
            return 2*R*Math.atan2(Math.sqrt(A), Math.sqrt(1-A));
        }

        function refreshNearbyList(){
            const list = document.getElementById('nearby-list'); list.innerHTML = '';
            const countEl = document.getElementById('nearby-count');
            const drivers = window._lastDriversSnapshot || [];
            if(!currentLocation){
                countEl.textContent = '';
                const li = document.createElement('li'); li.className='list-group-item';
                li.textContent = 'Click on the map or use "Use my location" to set your location.';
                list.appendChild(li); return;
            }
            const sorted = drivers
                .filter(d=> typeof d.lat==='number' && typeof d.lng==='number')
                .map(d=> ({...d, km: distanceKm(currentLocation, {lat:d.lat, lng:d.lng}) }))
                .sort((a,b)=> a.km - b.km)
                .slice(0, 20);
            countEl.textContent = `${sorted.length} shown`;
            sorted.forEach(d=>{
                const li = document.createElement('li');
                li.className='list-group-item d-flex justify-content-between align-items-center';
                const left = document.createElement('div');
                left.innerHTML = `<strong>${d.name||'Driver'}</strong><br/><small>${d.vehicle||''}</small>`;
                const right = document.createElement('div');
                right.innerHTML = `<div>${d.km.toFixed(2)} km</div>`;
                const btn = document.createElement('button'); btn.className='btn btn-sm btn-primary mt-1 ms-2'; btn.textContent = 'Chat';
                btn.addEventListener('click', ()=> openChatWithDriver(d.id, d.name||'Driver'));
                right.appendChild(btn);
                li.appendChild(left); li.appendChild(right);
                list.appendChild(li);
            });
        }

        // ---------- Profile UI & Logic ----------
        async function openUserProfile(){
            const u = auth.currentUser; if(!u){ showAlert('Sign-in first', 'warning'); return; }
            const doc = await db.collection('profiles').doc(u.uid).get();
            const p = doc.exists ? doc.data() : {};
            document.getElementById('user-profile-name').value = p.name||'';
            document.getElementById('user-profile-email').value = u.email||'';
            document.getElementById('user-profile-phone').value = u.phoneNumber||'';
            showView('view-user-profile');
        }

        async function saveUserProfile(e){
            e.preventDefault();
            const u = auth.currentUser; if(!u) return showAlert('Not signed in');
            const name = document.getElementById('user-profile-name').value.trim();
            const update = { name };
            await db.collection('profiles').doc(u.uid).set(update, { merge: true });
            showAlert('Profile saved', 'success');
            renderHeaderSummary();
            showView('view-user-main');
        }

        async function openDriverEdit(){
            const u = auth.currentUser; if(!u) { showAlert('Sign-in as a driver first', 'warning'); return; }
            const p = await getProfileData(u.uid);
            if(!p || p.role !== 'driver') { showAlert('Access denied. You are not a driver.', 'danger'); showView('view-user-main'); return; }
            
            document.getElementById('driver-vehicle-info').value = p.vehicle||'';
            document.getElementById('driver-cost-per-km').value = p.costPerKm || 0;
            document.getElementById('driver-vehicle-image').value = p.vehicleImage || '';
            if(typeof p.lat === 'number') document.getElementById('driver-lat').value = p.lat;
            if(typeof p.lng === 'number') document.getElementById('driver-lng').value = p.lng;
            showView('view-driver-edit');
        }
        
        async function saveDriverDetails(e){
            e.preventDefault();
            const u = auth.currentUser; if(!u) return showAlert('Not signed in');
            const vehicle = document.getElementById('driver-vehicle-info').value.trim();
            const costPerKm = parseFloat(document.getElementById('driver-cost-per-km').value);
            const vehicleImage = document.getElementById('driver-vehicle-image').value.trim();
            
            if(!vehicle) return showAlert('Vehicle info is required.');
            if(Number.isNaN(costPerKm) || costPerKm <= 0) return showAlert('Enter a valid cost per km.');
            
            const update = { vehicle, costPerKm, vehicleImage };
            await db.collection('profiles').doc(u.uid).set(update, { merge: true });
            showAlert('Driver details saved', 'success');
            renderHeaderSummary();
            showView('view-driver-edit');
        }
        
        async function showDriverProfile(driverId){
            const driver = await getProfileData(driverId);
            if(!driver){ showAlert('Driver profile not found.', 'danger'); return; }
            
            const profileHtml = `
                <div class="card p-3 mb-3">
                    <div class="text-center mb-3">
                        ${driver.vehicleImage ? `<img src="${driver.vehicleImage}" class="img-fluid rounded-3 mb-2" style="max-height: 200px; object-fit: cover;" alt="Vehicle Image" />` : ''}
                        <h4>${driver.name || 'Driver'}</h4>
                        <p class="text-muted mb-0">${driver.vehicle || 'Vehicle details not available'}</p>
                        ${driver.costPerKm ? `<p class="fw-bold fs-5 text-success">₹${driver.costPerKm.toFixed(2)} / km</p>` : ''}
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-primary btn-lg" onclick="openChatWithDriver('${driverId}', '${driver.name || 'Driver'}')">Chat with Driver</button>
                    </div>
                </div>
            `;
            document.getElementById('driver-profile-details').innerHTML = profileHtml;
            showView('view-driver-profile');
        }

        async function manualUpdateLoc(){
            const u = auth.currentUser; if(!u) return showAlert('Not signed in');
            const lat = parseFloat(document.getElementById('driver-lat').value);
            const lng = parseFloat(document.getElementById('driver-lng').value);
            if(Number.isNaN(lat) || Number.isNaN(lng)) return showAlert('Enter valid lat/lng');
            await db.collection('profiles').doc(u.uid).set({ lat, lng }, { merge:true });
            showAlert('Location updated', 'success');
        }

        function startAutoLoc(){
            const u = auth.currentUser; if(!u) return showAlert('Not signed in');
            if(!navigator.geolocation) return showAlert('Geolocation not supported');
            if(driverAutoTimer) clearInterval(driverAutoTimer);
            
            document.getElementById('btn-auto-loc').style.display = 'none';
            document.getElementById('btn-auto-loc-stop').style.display = 'inline-block';

            const tick = ()=> navigator.geolocation.getCurrentPosition(async (pos)=>{
                const lat = pos.coords.latitude, lng = pos.coords.longitude;
                document.getElementById('driver-lat').value = lat.toFixed(6);
                document.getElementById('driver-lng').value = lng.toFixed(6);
                try{ await db.collection('profiles').doc(u.uid).set({ lat, lng }, { merge: true }); }catch(e){ console.log(e); }
            }, (err)=> console.log('geo err', err), { enableHighAccuracy:true, timeout: 10000 });
            tick();
            driverAutoTimer = setInterval(tick, 20000);
            showAlert('Auto location started', 'success');
        }
        function stopAutoLoc(){
            if(driverAutoTimer){
                clearInterval(driverAutoTimer);
                driverAutoTimer = null;
                document.getElementById('btn-auto-loc').style.display = 'inline-block';
                document.getElementById('btn-auto-loc-stop').style.display = 'none';
                showAlert('Auto location stopped', 'info');
            }
        }

        // ---------- Chat ----------
        let currentMessagesUnsub = null;
        async function openChatWithDriver(driverId, driverName){
            const u = auth.currentUser; if(!u) return showAlert('Sign in to chat', 'warning');
            const chatId = [u.uid, driverId].sort().join('_');
            window.currentChat = { chatId, driverId, driverName };
            document.getElementById('chat-with-name').textContent = driverName;
            showView('view-chat');
            const box = document.getElementById('chat-messages'); box.innerHTML = '<div class="text-muted small">Loading…</div>';
            if(currentMessagesUnsub) currentMessagesUnsub();
            const chatRef = db.collection('chats').doc(chatId);
            const exists = await chatRef.get();
            if(!exists.exists){ await chatRef.set({ participants:[u.uid, driverId], createdAt: firebase.firestore.FieldValue.serverTimestamp() }); }
            currentMessagesUnsub = chatRef.collection('messages').orderBy('ts').onSnapshot(snap=>{
                box.innerHTML = '';
                snap.forEach(doc=>{
                    const m = doc.data();
                    const row = document.createElement('div');
                    row.className = 'mb-1';
                    const mine = m.from === u.uid;
                    row.innerHTML = `<div class="${mine? 'text-end':''}"><span class="badge text-bg-${mine?'primary':'secondary'}">${m.fromName|| (mine? 'You':driverName)}</span> <span>${m.text}</span></div>`;
                    box.appendChild(row);
                });
                box.scrollTop = box.scrollHeight;
            }, err => showAlert('Chat error: ' + err.message));
        }

        async function sendMessage(e){
            e.preventDefault();
            const u = auth.currentUser; if(!u) return;
            const chat = window.currentChat; if(!chat) return;
            const txt = (document.getElementById('chat-input').value||'').trim();
            if(!txt) return;
            await db.collection('chats').doc(chat.chatId).collection('messages').add({
                from: u.uid,
                fromName: (await getProfileData(u.uid))?.name || 'Guest',
                text: txt,
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('chat-input').value='';
        }

        function loadChatList(){
            const u = auth.currentUser; if(!u || !db) return;
            const ul = document.getElementById('chats-list'); ul.innerHTML = '';
            db.collection('chats').where('participants','array-contains', u.uid).onSnapshot(async snap=>{
                ul.innerHTML='';
                const items = await Promise.all(snap.docs.map(async d=>{
                    const data = d.data(); const other = data.participants.find(p=>p!==u.uid);
                    const prof = await getProfileData(other);
                    return { id: d.id, other, name: prof?.name || 'Driver' };
                }));
                items.forEach(it=>{
                    const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `<span>${it.name}</span>`;
                    const btn = document.createElement('button'); btn.className='btn btn-sm btn-primary'; btn.textContent='Open';
                    btn.addEventListener('click', ()=> openChatWithDriver(it.other, it.name));
                    li.appendChild(btn); ul.appendChild(li);
                });
            });
        }
        
        // ---------- Header/Profile Summary ----------
        async function renderHeaderSummary(){
            const u = auth.currentUser;
            const nameEl = document.getElementById('user-name');
            const badge = document.getElementById('badge-role');
            if(!u){ nameEl.textContent=''; badge.style.display='none'; return; }
            
            const p = await getProfileData(u.uid);
            const userRole = p?.role || 'user';
            
            nameEl.textContent = p?.name || u.displayName || u.email || 'Guest';
            badge.textContent = userRole === 'driver' ? 'Driver' : 'User';
            badge.style.display = 'inline-block';

            // Show/hide profile button based on role
            const profileBtn = document.getElementById('btn-profile-nav');
            if (userRole === 'driver') {
                profileBtn.textContent = 'Driver Control';
                profileBtn.onclick = openDriverEdit;
            } else {
                profileBtn.textContent = 'My Profile';
                profileBtn.onclick = openUserProfile;
            }
            profileBtn.style.display = 'inline-block';
        }

        // ---------- Auth state ----------
        function onAuthChanged(user){
            const logoutBtn = document.getElementById('btn-logout');
            if(user){
                logoutBtn.style.display='inline-block';
                
                // Determine user's role to show the right view
                getProfileData(user.uid).then(profile => {
                    const role = profile?.role || 'user';
                    if(role === 'driver'){
                        showView('view-driver-edit');
                    } else {
                        showView('view-user-main');
                    }
                    renderHeaderSummary();
                    loadChatList();
                });
                
            }else{
                logoutBtn.style.display='none';
                document.getElementById('btn-profile-nav').style.display='none';
                document.getElementById('user-name').textContent = '';
                document.getElementById('badge-role').style.display='none';
                showView('view-login');
                stopAutoLoc();
            }
        }

        // ---------- DOM events ----------
        document.getElementById('btn-google-signin').addEventListener('click', ()=> signInWithGoogle() );
        document.getElementById('btn-send-otp').addEventListener('click', (e)=>{ e.preventDefault(); sendOtp(); });
        document.getElementById('btn-verify-otp').addEventListener('click', (e)=>{ e.preventDefault(); verifyOtp(); });

        document.getElementById('btn-open-user-profile').addEventListener('click', openUserProfile);
        document.getElementById('user-profile-form').addEventListener('submit', saveUserProfile);
        document.getElementById('btn-back-main-from-user-profile').addEventListener('click', ()=> showView('view-user-main'));

        document.getElementById('driver-edit-form').addEventListener('submit', saveDriverDetails);
        document.getElementById('btn-update-loc').addEventListener('click', manualUpdateLoc);
        document.getElementById('btn-auto-loc').addEventListener('click', startAutoLoc);
        document.getElementById('btn-auto-loc-stop').addEventListener('click', stopAutoLoc);
        document.getElementById('btn-driver-view-profile').addEventListener('click', () => showDriverProfile(auth.currentUser.uid));

        document.getElementById('btn-my-loc').addEventListener('click', ()=>{
            if(navigator.geolocation){
                navigator.geolocation.getCurrentPosition(pos=> setUserLocation(pos.coords.latitude, pos.coords.longitude), err=> showAlert('Location error: ' + err.message));
            }else showAlert('Geolocation not supported');
        });
        document.getElementById('btn-search').addEventListener('click', ()=>{
            const q = document.getElementById('search-address').value.trim();
            if(!q) return showAlert('Enter an address');
            if(!geocoder) return showAlert('Geocoder not ready');
            geocoder.geocode({ address: q }, (res, status)=>{
                if(status==='OK' && res[0]){ const L = res[0].geometry.location; setUserLocation(L.lat(), L.lng()); }
                else showAlert('Geocode failed: ' + status);
            });
        });

        document.getElementById('chat-form').addEventListener('submit', sendMessage);
        document.getElementById('btn-chat-back').addEventListener('click', ()=> {
            getProfileData(auth.currentUser.uid).then(profile => {
                if(profile?.role === 'driver'){
                    showView('view-driver-edit');
                } else {
                    showView('view-user-main');
                }
            });
        });
        document.getElementById('btn-driver-profile-back').addEventListener('click', ()=> showView('view-user-main'));
        document.getElementById('btn-logout').addEventListener('click', ()=> auth.signOut());
        document.getElementById('brand-link').addEventListener('click', (e) => { e.preventDefault(); onAuthChanged(auth.currentUser); });

        // ---------- Boot ----------
        if(auth){ auth.onAuthStateChanged(onAuthChanged); }
        loadMaps();
    </script>
</body>
</html>
