<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Riderupee.in - Chat</title>
    <link rel="icon" href="riderupeelogo.PNG" type="image/png" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        :root { --brand: #ff6600; }
        .navbar { background: var(--brand); }
        .chat-box { max-height: 320px; overflow-y: auto; }
        #alert-area { position: fixed; top: 70px; right: 20px; z-index: 2000; width: 320px; }
        .role-badge { font-size: .8rem; }
    </style>
</head>
<body>
    <!-- Top Nav -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" id="brand-link">Riderupee.in</a>
            <div class="d-flex align-items-center" id="nav-right">
                <span id="user-name" class="text-white me-3"></span>
                <span id="badge-role" class="badge text-bg-dark role-badge me-3" style="display:none"></span>
                <button id="btn-profile-nav" class="btn btn-outline-light btn-sm me-2" style="display:none">Profile</button>
                <button id="btn-logout" class="btn btn-outline-light btn-sm" style="display:none">Logout</button>
            </div>
        </div>
    </nav>

    <div id="alert-area"></div>

    <div class="container my-4">
        <div class="card p-3">
            <div class="d-flex align-items-center justify-content-between">
                <h4 class="mb-0">Chat with <span id="chat-with-name"></span></h4>
                <button type="button" id="btn-chat-back" class="btn btn-link">Back</button>
            </div>
            <div class="chat-box border p-2 my-2" id="chat-messages"></div>
            <form id="chat-form" class="d-flex gap-2">
                <input id="chat-input" class="form-control" placeholder="Type a message or ask for a price" />
                <button class="btn btn-primary" type="submit">Send</button>
            </form>
        </div>
    </div>

 <!-- Footer -->
    <footer class="bg-dark text-white text-center text-lg-start mt-5">
        <div class="container p-4">
            <div class="row align-items-center">
                <div class="col-lg-6 col-md-12 mb-4 mb-md-0 text-start">
                    <div class="d-flex align-items-center mb-2">
                        <img src="riderupee.PNG" alt="RideRupee Logo" width="60" class="me-2" />
                        <h5 class="mb-0">Riderupee.in</h5>
                    </div>
                    <p class="mt-2">₹ide. ₹elax. ₹epeat.</p>
                </div>
                <div class="col-lg-6 col-md-12 mb-4 mb-md-0 text-md-end">
                    <p>Made with ❤️ in India</p>
                    <p class="mb-0">Contact: <a href="mailto:riderupee@gmail.com" class="text-white">riderupee@gmail.com</a></p>
                </div>
            </div>
        </div>
        <div class="text-center p-3 bg-dark text-white">© 2025 RideRupee. All rights reserved.</div>
    </footer>

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ===================== CONFIG — REPLACE WITH YOUR KEYS =====================
        const firebaseConfig = {
            apiKey: "AIzaSyCCsKOb_1Ug4oHbtuhnqqHIKILXKjTIB1s",
            authDomain: "riderupee-3d6a7.firebaseapp.com",
            projectId: "riderupee-3d6a7",
            storageBucket: "riderupee-3d6a7.firebaseapp.com",
            messagingSenderId: "723828361707",
            appId: "1:723828361707:web:c077cae44fcbd54c2f71ae",
            measurementId: "G-T79VTL0N2L"
        };
        const GOOGLE_MAPS_API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY'; // Not used on this page
        // =============================================================================

        // ---------- UI helpers ----------
        function showAlert(msg, type = 'danger', timeout = 6000){
            const id = 'alert' + Date.now();
            const container = document.getElementById('alert-area');
            const div = document.createElement('div');
            div.className = `alert alert-${type} alert-dismissible fade show`;
            div.id = id;
            div.innerHTML = `<div class="small">${msg}</div><button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            container.appendChild(div);
            if(timeout) setTimeout(()=>{ try{ const e = document.getElementById(id); if(e){ e.remove(); } } catch(e){} }, timeout);
        }

        // ---------- Firebase boot ----------
        let db = null, auth = null;
        try{
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("Firebase initialized in chat.html.");
        }catch(e){ 
            showAlert('Firebase init failed: ' + e.message, 'danger', 0); 
            console.error("Firebase init error in chat.html:", e);
        }

        async function getProfileData(uid){
            if(!db) return null;
            try {
                const snap = await db.collection('profiles').doc(uid).get();
                return snap.exists ? snap.data() : null;
            } catch (error) {
                console.error("Error fetching profile data in chat.html:", error);
                // Don't show an alert here, as it might happen before full UI is ready
                return null;
            }
        }

        // ---------- Chat ----------
        let currentMessagesUnsub = null;
        async function setupChat(){
            console.log("setupChat called.");
            const params = new URLSearchParams(window.location.search);
            const driverId = params.get('driverId');
            const driverName = params.get('driverName') || 'Driver';
            const u = auth.currentUser;

            console.log("Current user:", u ? u.uid : "None", "Driver ID:", driverId);

            if(!u) {
                showAlert('Sign in to chat', 'warning');
                console.warn("User not authenticated, redirecting to login.");
                // Redirecting to login should be handled by onAuthChanged, but keeping this for immediate feedback
                window.location.href = './login.html'; 
                return;
            }
            if(!driverId) {
                showAlert('No driver selected for chat.', 'danger');
                console.error("No driver ID found in URL parameters.");
                return;
            }

            const chatId = [u.uid, driverId].sort().join('_');
            window.currentChat = { chatId, driverId, driverName };
            const chatWithNameEl = document.getElementById('chat-with-name');
            if (chatWithNameEl) chatWithNameEl.textContent = decodeURIComponent(driverName);
            console.log("Chat ID:", chatId, "Chatting with:", decodeURIComponent(driverName));
            
            const box = document.getElementById('chat-messages'); 
            if (box) box.innerHTML = '<div class="text-muted small">Loading…</div>';
            if(currentMessagesUnsub) {
                currentMessagesUnsub(); // Unsubscribe from previous chat listener if any
                console.log("Unsubscribed from previous chat listener.");
            }
            
            const chatRef = db.collection('chats').doc(chatId);
            console.log("Checking if chat document exists...");
            try {
                const exists = await chatRef.get();
                if(!exists.exists){ 
                    console.log("Chat document does not exist, creating it.");
                    await chatRef.set({ participants:[u.uid, driverId], createdAt: firebase.firestore.FieldValue.serverTimestamp() }); 
                    showAlert('New chat created!', 'info');
                } else {
                    console.log("Chat document already exists.");
                }
            } catch (error) {
                console.error("Error checking/creating chat document:", error);
                showAlert(`Error setting up chat: ${error.message}`, 'danger');
                return; // Stop setup if initial chat doc creation/check fails
            }
            
            console.log("Setting up chat messages listener...");
            currentMessagesUnsub = chatRef.collection('messages').orderBy('ts').onSnapshot(snap=>{
                console.log("New message snapshot received. Docs:", snap.docs.length);
                if (box) box.innerHTML = ''; // Clear existing messages
                snap.forEach(doc=>{
                    const m = doc.data();
                    const row = document.createElement('div');
                    row.className = 'mb-1';
                    const mine = m.from === u.uid;
                    row.innerHTML = `<div class="${mine? 'text-end':''}"><span class="badge text-bg-${mine?'primary':'secondary'}">${m.fromName|| (mine? 'You':decodeURIComponent(driverName))}</span> <span>${m.text}</span></div>`;
                    if (box) box.appendChild(row);
                });
                if (box) box.scrollTop = box.scrollHeight; // Scroll to bottom
            }, err => {
                console.error("Chat messages stream error:", err);
                showAlert('Chat error: ' + err.message, 'danger');
            });
        }

        async function sendMessage(e){
            e.preventDefault();
            console.log("sendMessage called.");
            const u = auth.currentUser; 
            if(!u) {
                console.warn("Cannot send message: No user authenticated.");
                return;
            }
            const chat = window.currentChat; 
            if(!chat) {
                console.warn("Cannot send message: No active chat context.");
                showAlert('Chat not set up. Please try reloading the page.', 'warning');
                return;
            }
            const txtInput = document.getElementById('chat-input');
            const txt = (txtInput ? txtInput.value : '').trim();
            if(!txt) {
                console.log("Message text is empty, not sending.");
                return;
            }
            console.log("Sending message:", txt, "to chat:", chat.chatId);
            try {
                await db.collection('chats').doc(chat.chatId).collection('messages').add({
                    from: u.uid,
                    fromName: (await getProfileData(u.uid))?.name || 'Guest', // Fetch sender's name
                    text: txt,
                    ts: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log("Message sent successfully.");
                if (txtInput) txtInput.value=''; // Clear input after sending
            } catch (error) {
                console.error("Failed to send message:", error);
                showAlert(`Failed to send message: ${error.message}. Check chat rules.`, 'danger');
            }
        }

        // ---------- Header/Profile Summary ----------
        async function renderHeaderSummary(){
            const u = auth.currentUser;
            const nameEl = document.getElementById('user-name');
            const badge = document.getElementById('badge-role');
            if(!u){ 
                if (nameEl) nameEl.textContent=''; 
                if (badge) badge.style.display='none'; 
                return; 
            }
            
            const p = await getProfileData(u.uid);
            const userRole = p?.role || 'user'; // Default to user if not set
            
            if (nameEl) nameEl.textContent = p?.name || u.displayName || u.email || 'Guest';
            if (badge) {
                badge.textContent = userRole === 'driver' ? 'Driver' : 'User';
                badge.style.display = 'inline-block';
            }

            const profileBtn = document.getElementById('btn-profile-nav');
            if (profileBtn) {
                if (userRole === 'driver') {
                    profileBtn.textContent = 'Driver Control';
                    profileBtn.onclick = () => window.location.href = './driver-edit.html';
                } else {
                    profileBtn.textContent = 'My Profile';
                    profileBtn.onclick = () => window.location.href = './user-profile.html';
                }
                profileBtn.style.display = 'inline-block';
            }
        }

        // ---------- Auth state management for this page ----------
        function onAuthChanged(user){
            console.log("onAuthChanged called in chat.html. User:", user ? user.uid : "None");
            const logoutBtn = document.getElementById('btn-logout');
            if(user){
                if (logoutBtn) logoutBtn.style.display='inline-block';
                // Check if user's role is valid or redirect
                getProfileData(user.uid).then(profile => {
                    if (!profile) {
                        showAlert('Your profile could not be loaded. Please log in again.', 'warning');
                        console.warn("Profile not found for authenticated user, redirecting to login.");
                        window.location.href = './login.html'; // Profile not found, redirect to login
                    } else {
                        renderHeaderSummary();
                        setupChat(); // Initialize chat for the logged-in user
                    }
                }).catch(err => {
                    showAlert('Error fetching profile: ' + err.message, 'danger');
                    console.error("Error in onAuthChanged profile fetch:", err);
                    window.location.href = './login.html'; // Redirect to login on error
                });
            }else{
                if (logoutBtn) logoutBtn.style.display='none';
                const profileBtn = document.getElementById('btn-profile-nav');
                if (profileBtn) profileBtn.style.display='none';
                const userNameEl = document.getElementById('user-name');
                if (userNameEl) userNameEl.textContent = '';
                const badgeRoleEl = document.getElementById('badge-role');
                if (badgeRoleEl) badgeRoleEl.style.display='none';
                console.log("No user, redirecting to login.");
                window.location.href = './login.html';
            }
        }

        // ---------- DOM events ----------
        const chatForm = document.getElementById('chat-form');
        if (chatForm) {
            chatForm.addEventListener('submit', sendMessage);
            console.log("Chat form listener attached.");
        }

        const btnChatBack = document.getElementById('btn-chat-back');
        if (btnChatBack) {
            btnChatBack.addEventListener('click', ()=> {
                console.log("Back button clicked.");
                if (!auth.currentUser) {
                    window.location.href = './login.html'; // Fallback if no user
                    return;
                }
                getProfileData(auth.currentUser.uid).then(profile => {
                    if(profile?.role === 'driver'){
                        window.location.href = './driver-edit.html';
                    } else {
                        window.location.href = './user-main.html';
                    }
                }).catch(err => {
                    console.error("Error determining role for back button:", err);
                    window.location.href = './user-main.html'; // Default back to user main on error
                });
            });
            console.log("Chat back button listener attached.");
        }

        const btnLogout = document.getElementById('btn-logout');
        if (btnLogout) {
            btnLogout.addEventListener('click', ()=> {
                console.log("Logout button clicked.");
                auth.signOut().then(() => {
                    window.location.href = './login.html';
                }).catch(err => {
                    console.error("Logout error:", err);
                    showAlert(`Logout failed: ${err.message}`, 'danger');
                });
            });
            console.log("Logout button listener attached.");
        }

        const brandLink = document.getElementById('brand-link');
        if (brandLink) {
             brandLink.addEventListener('click', (e) => {
                e.preventDefault();
                console.log("Brand link clicked.");
                if(auth.currentUser) {
                    getProfileData(auth.currentUser.uid).then(profile => {
                        if(profile?.role === 'driver') {
                            window.location.href = './driver-edit.html';
                        } else {
                            window.location.href = './user-main.html';
                        }
                    }).catch(err => {
                        console.error("Error determining role for brand link:", err);
                        window.location.href = './user-main.html'; // Default back to user main on error
                    });
                } else {
                    window.location.href = './login.html';
                }
            });
            console.log("Brand link listener attached.");
        }

        // ---------- Boot ----------
        console.log("Chat.html script booting.");
        if(auth){ auth.onAuthStateChanged(onAuthChanged); } else { console.error("Firebase Auth not available."); }
    </script>
</body>
</html>
