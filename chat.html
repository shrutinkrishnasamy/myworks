<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Riderupee.in - Chat</title>
    <link rel="icon" href="riderupeelogo.PNG" type="image/png" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        :root { --brand: #ff6600; }
        .navbar { background: var(--brand); }
        .chat-box { max-height: 320px; overflow-y: auto; }
        #alert-area { position: fixed; top: 70px; right: 20px; z-index: 2000; width: 320px; }
        .role-badge { font-size: .8rem; }
    </style>
</head>
<body>
    <!-- Top Nav -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" id="brand-link">Riderupee.in</a>
            <div class="d-flex align-items-center" id="nav-right">
                <span id="user-name" class="text-white me-3"></span>
                <span id="badge-role" class="badge text-bg-dark role-badge me-3" style="display:none"></span>
                <button id="btn-profile-nav" class="btn btn-outline-light btn-sm me-2" style="display:none">Profile</button>
                <button id="btn-logout" class="btn btn-outline-light btn-sm" style="display:none">Logout</button>
            </div>
        </div>
    </nav>

    <div id="alert-area"></div>

    <div class="container my-4">
        <div class="card p-3">
            <div class="d-flex align-items-center justify-content-between">
                <h4 class="mb-0">Chat with <span id="chat-with-name"></span></h4>
                <button type="button" id="btn-chat-back" class="btn btn-link">Back</button>
            </div>
            <div class="chat-box border p-2 my-2" id="chat-messages"></div>
            <form id="chat-form" class="d-flex gap-2">
                <input id="chat-input" class="form-control" placeholder="Type a message or ask for a price" />
                <button class="btn btn-primary" type="submit">Send</button>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white text-center text-lg-start mt-5">
        <div class="container p-4">
            <div class="row align-items-center">
                <div class="col-lg-6 col-md-12 mb-4 mb-md-0 text-start">
                    <div class="d-flex align-items-center mb-2">
                        <img src="riderupee.PNG" alt="RideRupee Logo" width="60" class="me-2" />
                        <h5 class="mb-0">Riderupee.in</h5>
                    </div>
                    <p class="mt-2">₹ide. ₹elax. ₹epeat.</p>
                </div>
                <div class="col-lg-6 col-md-12 mb-4 mb-md-0 text-md-end">
                    <p>Made with ❤️ in India</p>
                    <p class="mb-0">Contact: <a href="mailto:riderupee@gmail.com" class="text-white">riderupee@gmail.com</a></p>
                </div>
            </div>
        </div>
        <div class="text-center p-3 bg-dark text-white">© 2025 RideRupee. All rights reserved.</div>
    </footer>

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("Chat.html DOM loaded.");

    // ===================== CONFIG — REPLACE WITH YOUR KEYS =====================
    const firebaseConfig = {
        apiKey: "AIzaSyCCsKOb_1Ug4oHbtuhnqqHIKILXKjTIB1s",
        authDomain: "riderupee-3d6a7.firebaseapp.com",
        projectId: "riderupee-3d6a7",
        storageBucket: "riderupee-3d6a7.appspot.com",
        messagingSenderId: "723828361707",
        appId: "1:723828361707:web:c077cae44fcbd54c2f71ae",
        measurementId: "G-T79VTL0N2L"
    };
    // =============================================================================

    // ---------- UI helpers ----------
    function showAlert(msg, type = 'danger', timeout = 6000) {
        const id = 'alert' + Date.now();
        const container = document.getElementById('alert-area');
        const div = document.createElement('div');
        div.className = `alert alert-${type} alert-dismissible fade show`;
        div.id = id;
        div.innerHTML = `<div class="small">${msg}</div>
                         <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        container.appendChild(div);
        if (timeout) setTimeout(() => {
            const e = document.getElementById(id);
            if (e) e.remove();
        }, timeout);
    }

    // ---------- Firebase boot ----------
    let db = null, auth = null;
    try {
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        console.log("Firebase initialized.");
    } catch (e) {
        showAlert('Firebase init failed: ' + e.message, 'danger', 0);
        return;
    }

    async function getProfileData(uid) {
        if (!db) return null;
        try {
            const snap = await db.collection('profiles').doc(uid).get();
            return snap.exists ? snap.data() : null;
        } catch (error) {
            console.error("Error fetching profile data:", error);
            return null;
        }
    }

    // ---------- Chat ----------
    let currentMessagesUnsub = null;
    async function setupChat() {
        console.log("setupChat called.");
        const params = new URLSearchParams(window.location.search);
        let driverId = params.get('driverId');
        let driverNameFromUrl = params.get('driverName'); // Get driverName from URL
        
        // Use driverName from URL first, then fallback to localStorage if available
        let driverName = driverNameFromUrl || localStorage.getItem('lastDriverName');

        // Recover from localStorage if driverId is missing in URL
        if (!driverId) driverId = localStorage.getItem('lastDriverId');

        const u = auth.currentUser;
        if (!u) {
            showAlert('Sign in to chat', 'warning');
            window.location.href = './login.html';
            return;
        }
        if (!driverId) {
            showAlert('No driver selected for chat. Please go back to main page and select a driver.', 'danger');
            return;
        }

        // Save for refresh recovery (always update with the latest from URL if present)
        localStorage.setItem('lastDriverId', driverId);
        if (driverNameFromUrl) { // Only update if driverName came from URL
            localStorage.setItem('lastDriverName', driverNameFromUrl);
        }

        const chatId = [u.uid, driverId].sort().join('_');
        window.currentChat = { chatId, driverId, driverName }; // Ensure driverName is stored here

        const chatWithNameEl = document.getElementById('chat-with-name');
        if (chatWithNameEl) chatWithNameEl.textContent = driverName || 'Driver'; // Display driver's name

        const box = document.getElementById('chat-messages');
        if (box) box.innerHTML = '<div class="text-muted small">Loading…</div>';

        if (currentMessagesUnsub) currentMessagesUnsub();

        const chatRef = db.collection('chats').doc(chatId);

        try {
            const exists = await chatRef.get();
            if (!exists.exists) {
                await chatRef.set({
                    participants: [u.uid, driverId],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showAlert('New chat created!', 'info');
            }
        } catch (error) {
            console.error("Error creating chat doc:", error);
            showAlert(`Error setting up chat: ${error.message}`, 'danger');
            return;
        }

        currentMessagesUnsub = chatRef.collection('messages')
            .orderBy('ts')
            .onSnapshot(snap => {
                if (!box) return;
                if (snap.empty) {
                    box.innerHTML = '<div class="text-muted small">No messages yet</div>';
                } else {
                    box.innerHTML = '';
                    snap.forEach(doc => {
                        const m = doc.data();
                        const mine = m.from === u.uid;
                        const row = document.createElement('div');
                        row.className = 'mb-1';
                        row.innerHTML = `<div class="${mine ? 'text-end' : ''}">
                            <span class="badge text-bg-${mine ? 'primary' : 'secondary'}">
                                ${m.fromName || (mine ? 'You' : driverName)}
                            </span> 
                            <span>${m.text}</span>
                        </div>`;
                        box.appendChild(row);
                    });
                }
                box.scrollTop = box.scrollHeight;
            }, err => {
                console.error("Chat stream error:", err);
                showAlert('Chat error: ' + err.message, 'danger');
            });
    }

    async function sendMessage(e) {
        e.preventDefault();
        const u = auth.currentUser;
        if (!u || !window.currentChat) return;
        const txtInput = document.getElementById('chat-input');
        const txt = (txtInput.value || '').trim();
        if (!txt) return;

        try {
            await db.collection('chats').doc(window.currentChat.chatId)
                .collection('messages').add({
                    from: u.uid,
                    fromName: (await getProfileData(u.uid))?.name || 'Guest',
                    text: txt,
                    ts: firebase.firestore.FieldValue.serverTimestamp()
                });
            txtInput.value = '';
        } catch (error) {
            console.error("Send message error:", error);
            showAlert(`Failed to send message: ${error.message}`, 'danger');
        }
    }

    // ---------- Header/Profile ----------
    async function renderHeaderSummary(){
        const u = auth.currentUser;
        const nameEl = document.getElementById('user-name');
        const badge = document.getElementById('badge-role');
        if(!u){ 
            if (nameEl) nameEl.textContent=''; 
            if (badge) badge.style.display='none'; 
            return; 
        }
        
        const p = await getProfileData(u.uid);
        const userRole = p?.role || 'user';
        
        if (nameEl) nameEl.textContent = p?.name || u.displayName || u.email || 'Guest';
        if (badge) {
            badge.textContent = userRole === 'driver' ? 'Driver' : 'User';
            badge.style.display = 'inline-block';
        }

        const profileBtn = document.getElementById('btn-profile-nav');
        if (profileBtn) {
            if (userRole === 'driver') {
                profileBtn.textContent = 'Driver Control';
                profileBtn.onclick = () => window.location.href = './driver-edit.html';
            } else {
                profileBtn.textContent = 'My Profile';
                profileBtn.onclick = () => window.location.href = './user-profile.html';
            }
            profileBtn.style.display = 'inline-block';
        }
    }

    // ---------- Auth ----------
    function onAuthChanged(user){
        console.log("Auth state changed:", user ? user.uid : "None");
        if (!user) {
            window.location.href = './login.html';
            return;
        }
        renderHeaderSummary().then(setupChat);
    }

    // ---------- Event Listeners ----------
    document.getElementById('chat-form')?.addEventListener('submit', sendMessage);

    // Modified back button to go to driver-edit.html if driver, else user-main.html
    document.getElementById('btn-chat-back')?.addEventListener('click', () => {
        if (!auth.currentUser) {
            window.location.href = './login.html';
            return;
        }
        getProfileData(auth.currentUser.uid).then(profile => {
            window.location.href = profile?.role === 'driver'
                ? './driver-edit.html' : './user-main.html';
        }).catch(() => window.location.href = './user-main.html');
    });

    document.getElementById('btn-logout')?.addEventListener('click', () => {
        auth.signOut().then(() => window.location.href = './login.html');
    });

    document.getElementById('brand-link')?.addEventListener('click', (e) => {
        e.preventDefault();
        if (auth.currentUser) {
            getProfileData(auth.currentUser.uid).then(profile => {
                window.location.href = profile?.role === 'driver'
                    ? './driver-edit.html' : './user-main.html';
            }).catch(() => window.location.href = './user-main.html');
        } else {
            window.location.href = './login.html';
        }
    });

    // ---------- Boot ----------
    if (auth) auth.onAuthStateChanged(onAuthChanged);
});
</script>

</body>
</html>
