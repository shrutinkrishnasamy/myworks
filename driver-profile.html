<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Riderupee.in - Driver Profile</title>
    <link rel="icon" href="riderupeelogo.PNG" type="image/png" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        :root { --brand: #ff6600; }
        .navbar { background: var(--brand); }
        #alert-area { position: fixed; top: 70px; right: 20px; z-index: 2000; width: 320px; }
        .role-badge { font-size: .8rem; }
        .profile-image-display {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            object-fit: cover;
            margin: 0 auto 15px auto; /* Center image */
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <!-- Top Nav -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" id="brand-link">Riderupee.in</a>
            <div class="d-flex align-items-center" id="nav-right">
                <span id="user-name" class="text-white me-3"></span>
                <span id="badge-role" class="badge text-bg-dark role-badge me-3" style="display:none"></span>
                <button id="btn-profile-nav" class="btn btn-outline-light btn-sm me-2" style="display:none">Profile</button>
                <button id="btn-logout" class="btn btn-outline-light btn-sm" style="display:none">Logout</button>
            </div>
        </div>
    </nav>

    <div id="alert-area"></div>

    <div class="container my-4">
        <div class="card p-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h4 class="mb-0" id="profile-page-title">Driver Profile</h4>
                <button type="button" id="btn-profile-back" class="btn btn-link">Back</button>
            </div>

            <!-- Content for Viewing Mode -->
            <div id="driver-profile-details" class="text-center">
                <div class="text-muted">Loading driver profile...</div>
            </div>

            <div class="d-grid gap-2 mt-4" id="driver-profile-actions">
                <!-- This button will appear if a user is viewing ANOTHER driver's profile -->
                <button class="btn btn-primary btn-lg" id="btn-chat-driver" style="display:none;">Chat with Driver</button>
                <!-- This button will appear if the driver is viewing THEIR OWN profile -->
                <button class="btn btn-outline-primary btn-lg" id="btn-edit-my-profile" style="display:none;">Edit My Profile</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white text-center text-lg-start mt-5">
        <div class="container p-4">
            <div class="row align-items-center">
                <div class="col-lg-6 col-md-12 mb-4 mb-md-0 text-start">
                    <div class="d-flex align-items-center mb-2">
                        <img src="riderupee.PNG" alt="RideRupee Logo" width="60" class="me-2" />
                        <h5 class="mb-0">Riderupee.in</h5>
                    </div>
                    <p class="mt-2">₹ide. ₹elax. ₹epeat.</p>
                </div>
                <div class="col-lg-6 col-md-12 mb-4 mb-md-0 text-md-end">
                    <p>Made with ❤️ in India</p>
                    <p class="mb-0">Contact: <a href="mailto:riderupee@gmail.com" class="text-white">riderupee@gmail.com</a></p>
                </div>
            </div>
        </div>
        <div class="text-center p-3 bg-dark text-white">© 2025 RideRupee. All rights reserved.</div>
    </footer>

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ===================== CONFIG — REPLACE WITH YOUR KEYS =====================
        const firebaseConfig = {
            apiKey: "AIzaSyCCsKOb_1Ug4oHbtuhnqqHIKILXKjTIB1s",
            authDomain: "riderupee-3d6a7.firebaseapp.com",
            projectId: "riderupee-3d6a7",
            storageBucket: "riderupee-3d6a7.firebaseapp.com",
            messagingSenderId: "723828361707",
            appId: "1:723828361707:web:c077cae44fcbd54c2f71ae",
            measurementId: "G-T79VTL0N2L"
        };
        const GOOGLE_MAPS_API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY_HERE'; // Not used on this page, but kept for consistency
        // =============================================================================

        // ---------- UI helpers ----------
        function showAlert(msg, type = 'danger', timeout = 6000){
            const id = 'alert' + Date.now();
            const container = document.getElementById('alert-area');
            const div = document.createElement('div');
            div.className = `alert alert-${type} alert-dismissible fade show`;
            div.id = id;
            div.innerHTML = `<div class="small">${msg}</div><button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            container.appendChild(div);
            if(timeout) setTimeout(()=>{ try{ const e = document.getElementById(id); if(e){ e.remove(); } } catch(e){} }, timeout);
        }

        // ---------- Firebase boot ----------
        let db = null, auth = null; 
        try{
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("Firebase initialized successfully.");
        }catch(e){ 
            showAlert('Firebase init failed: ' + e.message, 'danger', 0); 
            console.error("Firebase initialization error:", e);
        }

        async function getProfileData(uid){
            if(!db) return null;
            try {
                const snap = await db.collection('profiles').doc(uid).get();
                return snap.exists ? snap.data() : null;
            } catch (error) {
                console.error("Error fetching profile data:", error);
                showAlert(`Error fetching profile: ${error.message}`, 'danger');
                return null;
            }
        }

        // ---------- Profile Display Logic ----------
        async function loadDriverProfile() {
            const params = new URLSearchParams(window.location.search);
            const driverId = params.get('driverId');
            const detailsEl = document.getElementById('driver-profile-details');
            const chatButton = document.getElementById('btn-chat-driver');
            const editMyProfileButton = document.getElementById('btn-edit-my-profile'); // Get the edit button
            const profilePageTitle = document.getElementById('profile-page-title');

            if (!driverId) {
                if (detailsEl) detailsEl.innerHTML = '<div class="alert alert-danger">No driver ID specified.</div>';
                chatButton.style.display = 'none';
                editMyProfileButton.style.display = 'none'; // Ensure hidden
                return;
            }

            const driver = await getProfileData(driverId);

            if (!driver || driver.role !== 'driver') {
                if (detailsEl) detailsEl.innerHTML = '<div class="alert alert-warning">Driver profile not found or user is not a driver.</div>';
                chatButton.style.display = 'none';
                editMyProfileButton.style.display = 'none'; // Ensure hidden
                return;
            }
            
            const isCurrentUserProfile = (auth.currentUser && auth.currentUser.uid === driverId);

            profilePageTitle.textContent = isCurrentUserProfile ? 'My Driver Profile' : `${driver.name || 'Driver'}'s Profile`;

            const profileHtml = `
                <div class="card p-3 mb-3">
                    <div class="text-center mb-3">
                        ${driver.vehicleImage ? `<img src="${driver.vehicleImage}" class="profile-image-display mb-2" alt="Vehicle Image" onerror="this.onerror=null;this.src='https://placehold.co/200x150/e0e0e0/000000?text=No+Image';" />` : '<img src="https://placehold.co/200x150/e0e0e0/000000?text=No+Image" class="profile-image-display mb-2" alt="No Image" />'}
                        <h4>${driver.name || 'Driver'}</h4>
                        <p class="text-muted mb-0"><strong>Vehicle:</strong> ${driver.vehicle || 'Not specified'}</p>
                        ${driver.phone ? `<p class="text-muted mb-0"><strong>Phone:</strong> ${driver.phone}</p>` : ''}
                        ${driver.costPerKm ? `<p class="fw-bold fs-5 text-success">₹${driver.costPerKm.toFixed(2)} / km</p>` : ''}
                        ${(typeof driver.lat === 'number' && typeof driver.lng === 'number') ?
                            `<p class="text-muted mb-0"><strong>Location:</strong> Currently Available</p>` :
                            `<p class="text-muted mb-0"><strong>Location:</strong> Not sharing live location</p>`
                        }
                    </div>
                </div>
            `;
            if (detailsEl) detailsEl.innerHTML = profileHtml;

            // Conditionally show buttons
            if (isCurrentUserProfile) {
                chatButton.style.display = 'none'; // Hide chat if it's their own profile
                editMyProfileButton.style.display = 'block'; // Show edit button
                editMyProfileButton.onclick = () => window.location.href = './driver-edit.html'; // Link to driver-edit.html
            } else {
                chatButton.style.display = 'block'; // Show chat if viewing another's profile
                chatButton.onclick = () => {
                    if (!auth.currentUser) {
                        showAlert('Please sign in to chat with a driver.', 'warning');
                        return;
                    }
                    window.location.href = `./chat.html?driverId=${driverId}&driverName=${encodeURIComponent(driver.name || 'Driver')}`;
                };
                editMyProfileButton.style.display = 'none'; // Hide edit button
            }
        }

        // ---------- Header/Profile Summary ----------
        async function renderHeaderSummary(){
            const u = auth.currentUser;
            const nameEl = document.getElementById('user-name');
            const badge = document.getElementById('badge-role');
            if(!u){ 
                if (nameEl) nameEl.textContent=''; 
                if (badge) badge.style.display='none'; 
                return; 
            }
            
            const p = await getProfileData(u.uid);
            const userRole = p?.role || 'user';
            
            if (nameEl) nameEl.textContent = p?.name || u.displayName || u.email || 'Guest';
            if (badge) {
                badge.textContent = userRole === 'driver' ? 'Driver' : 'User';
                badge.style.display = 'inline-block';
            }

            const profileBtn = document.getElementById('btn-profile-nav');
            if (profileBtn) {
                if (userRole === 'driver') {
                    profileBtn.textContent = 'Driver Control';
                    profileBtn.onclick = () => window.location.href = './driver-edit.html'; // Points to driver-edit.html
                } else {
                    profileBtn.textContent = 'My Profile';
                    profileBtn.onclick = () => window.location.href = './user-profile.html';
                }
                profileBtn.style.display = 'inline-block';
            }
        }

        // ---------- Auth state management for this page ----------
        function onAuthChanged(user){
            const logoutBtn = document.getElementById('btn-logout');
            if(user){
                if (logoutBtn) logoutBtn.style.display='inline-block';
                renderHeaderSummary(); // Render header first
                loadDriverProfile(); // Load profile details based on URL
            }else{
                window.location.href = './login.html'; // Redirect to login page if not authenticated
            }
        }

        // ---------- DOM events ----------
        const btnLogout = document.getElementById('btn-logout');
        if (btnLogout) {
            btnLogout.addEventListener('click', ()=> {
                auth.signOut().then(() => {
                    window.location.href = './login.html';
                });
            });
        }

        const brandLink = document.getElementById('brand-link');
        if (brandLink) {
             brandLink.addEventListener('click', (e) => {
                e.preventDefault();
                if(auth.currentUser) {
                    getProfileData(auth.currentUser.uid).then(profile => {
                        if(profile?.role === 'driver') {
                            window.location.href = './driver-edit.html'; // Points to driver-edit.html
                        } else {
                            window.location.href = './user-main.html';
                        }
                    });
                } else {
                    window.location.href = './login.html';
                }
            });
        }

        const btnProfileBack = document.getElementById('btn-profile-back');
        if (btnProfileBack) {
            btnProfileBack.addEventListener('click', () => window.location.href='./user-main.html');
        }

        // ---------- Boot ----------
        if(auth){ auth.onAuthStateChanged(onAuthChanged); }
    </script>
</body>
</html>
